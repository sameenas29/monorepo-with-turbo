{"version":3,"file":"35364602.js","sources":["../../../../../node_modules/worktop/cookie/index.mjs","../../../../../node_modules/@shopify/hydrogen/dist/esnext/foundation/Analytics/connectors/Shopify/utils.js","../../../../../node_modules/@shopify/hydrogen/dist/esnext/foundation/Analytics/connectors/Shopify/ShopifyAnalytics.client.js"],"sourcesContent":["// src/cookie.ts\nvar g = new Set([\n  \"domain\",\n  \"path\",\n  \"max-age\",\n  \"expires\",\n  \"samesite\",\n  \"secure\",\n  \"httponly\"\n]);\nfunction u(a) {\n  let r = {}, e, t, n = 0, m = a.split(/;\\s*/g), s, i;\n  for (; n < m.length; n++)\n    if (t = m[n], e = t.indexOf(\"=\"), ~e) {\n      if (s = t.substring(0, e++).trim(), i = t.substring(e).trim(), i[0] === '\"' && (i = i.substring(1, i.length - 1)), ~i.indexOf(\"%\"))\n        try {\n          i = decodeURIComponent(i);\n        } catch (f) {\n        }\n      g.has(t = s.toLowerCase()) ? t === \"expires\" ? r.expires = new Date(i) : t === \"max-age\" ? r.maxage = +i : r[t] = i : r[s] = i;\n    } else\n      (s = t.trim().toLowerCase()) && (s === \"httponly\" || s === \"secure\") && (r[s] = !0);\n  return r;\n}\nfunction l(a, r, e = {}) {\n  let t = a + \"=\" + encodeURIComponent(r);\n  return e.expires && (t += \"; Expires=\" + new Date(e.expires).toUTCString()), e.maxage != null && e.maxage >= 0 && (t += \"; Max-Age=\" + (e.maxage | 0)), e.domain && (t += \"; Domain=\" + e.domain), e.path && (t += \"; Path=\" + e.path), e.samesite && (t += \"; SameSite=\" + e.samesite), (e.secure || e.samesite === \"None\") && (t += \"; Secure\"), e.httponly && (t += \"; HttpOnly\"), t;\n}\nexport {\n  u as parse,\n  l as stringify\n};\n","const zeros = '00000000';\nconst tokenHash = 'xxxx-4xxx-xxxx-xxxxxxxxxxxx';\nexport function buildUUID() {\n    let hash = '';\n    try {\n        const crypto = window.crypto;\n        const randomValuesArray = new Uint16Array(31);\n        crypto.getRandomValues(randomValuesArray);\n        // Generate a strong UUID\n        let i = 0;\n        hash = tokenHash\n            .replace(/[x]/g, (c, ...args) => {\n            const r = randomValuesArray[i] % 16;\n            const v = c === 'x' ? r : (r & 0x3) | 0x8;\n            i++;\n            return v.toString(16);\n        })\n            .toUpperCase();\n    }\n    catch (err) {\n        // crypto not available, generate weak UUID\n        hash = tokenHash\n            .replace(/[x]/g, (c, ...args) => {\n            const r = (Math.random() * 16) | 0;\n            const v = c === 'x' ? r : (r & 0x3) | 0x8;\n            return v.toString(16);\n        })\n            .toUpperCase();\n    }\n    return `${hexTime()}-${hash}`;\n}\nexport function hexTime() {\n    // 32 bit representations of new Date().getTime() and performance.now()\n    let dateNumber = 0;\n    let perfNumber = 0;\n    // Result of zero-fill right shift is always positive\n    dateNumber = new Date().getTime() >>> 0;\n    try {\n        perfNumber = performance.now() >>> 0;\n    }\n    catch (err) {\n        perfNumber = 0;\n    }\n    const output = Math.abs(dateNumber + perfNumber)\n        .toString(16)\n        .toLowerCase();\n    return zeros.substr(0, 8 - output.length) + output;\n}\nexport function addDataIf(keyValuePairs, formattedData) {\n    Object.entries(keyValuePairs).forEach(([key, value]) => {\n        if (value) {\n            formattedData[key] = value;\n        }\n    });\n    return formattedData;\n}\n","import { useEffect } from 'react';\nimport { parse, stringify } from 'worktop/cookie';\nimport { SHOPIFY_Y, SHOPIFY_S } from '../../../../constants';\nimport { ClientAnalytics } from '../../ClientAnalytics';\nimport { buildUUID, addDataIf } from './utils';\nconst longTermLength = 60 * 60 * 24 * 360 * 2; // ~2 year expiry\nconst shortTermLength = 60 * 30; // 30 mins\nconst myShopifyDomain = 'myshopify.com';\nconst oxygenDomain = 'myshopify.dev';\nlet isInit = false;\nlet microSessionCount = 0;\nexport function ShopifyAnalyticsClient({ cookieDomain }) {\n    useEffect(() => {\n        try {\n            // Find Shopify cookies\n            const cookieData = parse(document.cookie);\n            const shopifyYCookie = cookieData[SHOPIFY_Y] || buildUUID();\n            const shopifySCookie = cookieData[SHOPIFY_S] || buildUUID();\n            /**\n             * Set user and session cookies and refresh the expiry time\n             */\n            updateCookie(SHOPIFY_Y, shopifyYCookie, longTermLength, cookieDomain);\n            updateCookie(SHOPIFY_S, shopifySCookie, shortTermLength, cookieDomain);\n            ClientAnalytics.pushToPageAnalyticsData({\n                shopify: {\n                    pageId: buildUUID(),\n                    userId: shopifyYCookie,\n                    sessionId: shopifySCookie,\n                },\n            });\n            microSessionCount = 0;\n            // TODO: Fix with useEvent when ready\n            // RFC: https://github.com/reactjs/rfcs/blob/useevent/text/0000-useevent.md\n            if (!isInit) {\n                isInit = true;\n                const eventNames = ClientAnalytics.eventNames;\n                ClientAnalytics.subscribe(eventNames.PAGE_VIEW, trackPageView);\n                // On a slow network, the pageview event could be already fired before\n                // we subscribed to the pageview event\n                if (ClientAnalytics.hasSentFirstPageView()) {\n                    trackPageView(ClientAnalytics.getPageAnalyticsData());\n                }\n            }\n        }\n        catch (err) {\n            // Do nothing\n        }\n    });\n    return null;\n}\nfunction updateCookie(cookieName, value, maxage, cookieDomain) {\n    const cookieString = stringify(cookieName, value, {\n        maxage,\n        domain: getCookieDomain(cookieDomain),\n        secure: process.env.NODE_ENV === 'production',\n        samesite: 'Lax',\n        path: '/',\n    });\n    document.cookie = cookieString;\n    return cookieString;\n}\nfunction getCookieDomain(cookieDomain) {\n    const hostname = location.hostname;\n    if (hostname.indexOf(myShopifyDomain) !== -1) {\n        return `.${hostname.split('.').slice(-3).join('.')}`;\n    }\n    else if (hostname.indexOf(cookieDomain) !== -1) {\n        return `.${cookieDomain}`;\n    }\n    else {\n        return '';\n    }\n}\nfunction trackPageView(payload) {\n    microSessionCount += 1;\n    try {\n        sendToServer(storefrontPageViewSchema(payload));\n    }\n    catch (error) {\n        console.error(`Error Shopify analytics: ${ClientAnalytics.eventNames.PAGE_VIEW}`, error);\n    }\n}\nfunction storefrontPageViewSchema(payload) {\n    return {\n        schema_id: 'trekkie_storefront_page_view/1.4',\n        payload: buildStorefrontPageViewPayload(payload),\n        metadata: {\n            event_created_at_ms: Date.now(),\n        },\n    };\n}\nfunction buildStorefrontPageViewPayload(payload) {\n    const location = document.location;\n    const shopify = payload.shopify;\n    let formattedData = {\n        appClientId: '6167201',\n        hydrogenSubchannelId: shopify.storefrontId,\n        isPersistentCookie: shopify.isPersistentCookie,\n        uniqToken: shopify.userId,\n        visitToken: shopify.sessionId,\n        microSessionId: shopify.pageId,\n        microSessionCount,\n        url: location.href,\n        path: location.pathname,\n        search: location.search,\n        referrer: document.referrer,\n        title: document.title,\n        shopId: stripGId(shopify.shopId),\n        currency: shopify.currency,\n        contentLanguage: shopify.acceptedLanguage,\n    };\n    formattedData = addDataIf({\n        isMerchantRequest: isMerchantRequest(),\n    }, formattedData);\n    formattedData = addDataIf({\n        pageType: shopify.pageType,\n    }, formattedData);\n    if (shopify.resourceId) {\n        try {\n            formattedData = addDataIf({\n                resourceType: getResourceType(shopify.resourceId),\n                resourceId: stripGId(shopify.resourceId),\n            }, formattedData);\n        }\n        catch (err) {\n            // do nothing\n        }\n    }\n    formattedData = addDataIf({\n        customerId: shopify.customerId,\n    }, formattedData);\n    return formattedData;\n}\nfunction isMerchantRequest() {\n    const hostname = location.hostname;\n    if (hostname.indexOf(oxygenDomain) !== -1 || hostname === 'localhost') {\n        return true;\n    }\n    return false;\n}\nfunction stripGId(text) {\n    return parseInt(text.substring(text.lastIndexOf('/') + 1));\n}\nfunction getResourceType(text) {\n    return text\n        .substring(0, text.lastIndexOf('/'))\n        .replace(/.*shopify\\//, '')\n        .toLowerCase();\n}\nconst BATCH_SENT_TIMEOUT = 500;\nlet batchedData = [];\nlet batchedTimeout;\nfunction sendToServer(data) {\n    batchedData.push(data);\n    if (batchedTimeout) {\n        clearTimeout(batchedTimeout);\n        batchedTimeout = null;\n    }\n    batchedTimeout = setTimeout(() => {\n        const batchedDataToBeSent = {\n            events: batchedData,\n            metadata: {\n                event_sent_at_ms: Date.now(),\n            },\n        };\n        batchedData = [];\n        batchedTimeout = null;\n        // Send to Shopify\n        try {\n            fetch('https://monorail-edge.shopifysvc.com/unstable/produce_batch', {\n                method: 'post',\n                headers: {\n                    'content-type': 'text/plain',\n                },\n                body: JSON.stringify(batchedDataToBeSent),\n            });\n        }\n        catch (error) {\n            // Do nothing\n        }\n    }, BATCH_SENT_TIMEOUT);\n}\n"],"names":["useEffect","parse","stringify"],"mappings":"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"}